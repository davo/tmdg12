<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>TMDG Live Map</title>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://libs.cartocdn.com/cartodb.js/v2/cartodb.js"></script>
    <script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>

    <style type="text/css">
 
    @import url(stylesheets/style.css);



    body{
        background: #ff5a00;
    }

    svg:active {
      cursor: none;
    }
    circle {
      stroke-width: 2px;
    }
    #first_layer path {
      fill-opacity:1px;
      fill: #ffe002;
      stroke: #ffe002;
      stroke-width:1px;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
 
    .ATA, .HRV {
      /*
       * Borro Antartida y Croacia porque se rompen misteriosamente.
       */
        fill: none !important;
    }

    </style>
  </head>
  <body>

  <div id="refer">

  <h1>#TMDG12 / Mapa</h1>
  <p>Creamos un mapa colaborativo para poder visualizar desde donde vienen todos.</p>
  </div>
    <script type="text/javascript">
 var width = 1440,
    height = 900;


var aspect = 11 / 3,
    chart = $("#chart");
$(window).on("resize", function() {
    var targetWidth = chart.parent().width();
    chart.attr("width", targetWidth);
    chart.attr("height", targetWidth / aspect);
});

var svg = d3.select("body")
    .append("svg")
      .attr({
        "width": "1440",
        "height": "900",
        "id": "chart"
      })
      .attr("viewBox", "0 0 " + width + " " + height )
      //.attr("preserveAspectRatio", "xMidYMid")
      .attr("pointer-events", "all")
    .call(d3.behavior.zoom().on("zoom", redraw))
    .append("g");

var vis = svg;

function redraw() {
  vis.attr("transform",
      "translate(" + d3.event.translate + ")"
      + " scale(" + d3.event.scale + ")");
}

    var first_layer = 'tm_world_borders_simpl_0_4';
 
    var sql = new cartodb.SQL({ user: 'pixelbeat-v21', format: 'geojson', dp: 5});

           
 
    // Our projection.
    var xy = d3.geo.mercator();
        xy.scale(420);
        xy.center([-90,0]);
        xy.precision(0);
        
    svg.append("g").attr("id", "first_layer");
 

    
    var path = d3.geo.path();
    
    sql.execute("SELECT ST_Simplify(the_geom,0.0001) as the_geom, iso3 FROM {{table_name}} WHERE the_geom IS NOT NULL", {table_name: first_layer})
      .done(function(collection) {
          svg.select("#first_layer")
            .selectAll("path")
              .data(collection.features)
            .enter().append("path")
            .attr("class", function(d) { return "country " + d.properties.iso3; })
            .attr("d", path.projection(xy));
      })
      .error(function(errors) {
        // console.log('Errors! Oh no!')
      });
 
    var ciudades;
    sql.execute("SELECT the_geom, st_x(the_geom) lng, st_y(the_geom) lat, ciudad, count(*) as cnt FROM tmdg WHERE the_geom IS NOT NULL GROUP BY ciudad, the_geom")
      .done(function(collection) {
        ciudades = collection.features;
        console.log(ciudades)
        shower();
      });
 
    var i = 0;
    function shower() {
      var c = ciudades[i];
      svg.append("circle")
          .attr("cx", xy(c.geometry.coordinates)[0])
          .attr("cy", xy(c.geometry.coordinates)[1])
          .attr("r", 4)
          .style("fill", "#ff5a00")
          .style("fill-opacity", .2)
          .style("stroke", "#ffe002")
          .style("stroke-opacity", .7)
        .transition()
          .duration(4000)
          .ease(Math.sqrt)
          .attr("r", c.properties.cnt*5)
          .style("fill-opacity", 1e-8)
          .style("stroke-opacity", 1e-5)
          .remove()
        setTimeout(shower, 5);
      i++;
      if (ciudades.length==i) i = 0;
    }
 
    function redraw() {
      svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
    }

 
    </script>
  </body>
</html>
